# Memory Fix Guide - Loading Large JSON Files

## Problem
The app was encountering Out of Memory (OOM) errors when trying to load the large gzipped JSON file (`initial-resources.json.gz`, ~49MB compressed, ~355MB uncompressed). The error showed:

```
Failed to allocate a 130538496 byte allocation with 24336888 free bytes and 23MB until OOM, 
target footprint 201326592, growth limit 201326592
```

This is **NOT an emulator-only issue** - it's a real limitation of the default Android heap size allocation.

## Solution Applied

### 1. Enable Large Heap in Android
We added `"largeHeap": true` to the Android configuration in `app.json`:

```json
"android": {
  ...
  "largeHeap": true
}
```

This tells Android to allocate more memory to the app. The default heap limit is typically 192-256MB, but with `largeHeap` enabled, it can go up to 512MB or more depending on the device.

### 2. Simplified JSON Loading
We simplified the `loadInitialResourcesFromJSON()` method in `DatabaseManager.ts` to:
- Load the gzipped asset
- Decompress it with `pako` library
- Parse the JSON
- Insert records in batches

## What You Need to Do

### Step 1: Rebuild the App
The `largeHeap` setting requires rebuilding the native Android app:

```bash
# Stop the current dev server
# Then rebuild the Android app
pnpm run build:android:debug

# Or for a clean rebuild
pnpm run build:android:clean
pnpm run build:android:debug
```

### Step 2: Reinstall the App
```bash
# Install the newly built APK
pnpm run install:android:debug
```

### Step 3: Start the Dev Server
```bash
pnpm start
```

### Step 4: Test
Launch the app and check if the initial resources load successfully. You should see logs like:

```
ðŸ”„ Loading initial resources from JSON...
ðŸ“¦ Asset downloaded, processing file...
ðŸ“¦ Compressed size: 49.XX MB
ðŸ”„ Decompressing with pako...
ðŸ“¦ Decompressed size: 355.XX MB
ðŸ“„ Parsing JSON...
ðŸ“Š Loaded XXX metadata and XXXX content records
ðŸ“ Inserting XXX metadata records...
ðŸ“ Processing XXXX content records in batches of 1000...
âœ… Initial resources loaded successfully from JSON
```

## Alternative Approaches (If This Doesn't Work)

If the `largeHeap` approach still causes OOM errors on some devices:

### Option 1: Download on First Launch
- Ship with an empty database
- Download resources from a server on first launch
- Process in smaller chunks
- **Pros**: Small app size, always up-to-date, no memory issues
- **Cons**: Requires internet, slower first launch

### Option 2: Bundle Pre-populated Database
- Use the `.db` file generated by `app-db-converter.ts`
- Copy it to the app's database location on first launch
- **Pros**: Fast, no memory issues, works offline
- **Cons**: Larger app size (~50MB), harder to update

### Option 3: Split JSON into Chunks
- Split the large JSON into smaller files (e.g., by resource type)
- Load them one at a time
- **Pros**: More control over memory usage
- **Cons**: More complex, requires restructuring the data

## Testing on Physical Devices

It's important to test on physical devices because:
- Different devices have different memory limits
- Emulators may have different memory characteristics
- Real-world performance can vary significantly

## Memory Limits by Android Version

Typical heap limits (without `largeHeap`):
- **Low-end devices**: 128-192 MB
- **Mid-range devices**: 192-256 MB
- **High-end devices**: 256-512 MB

With `largeHeap` enabled:
- **Low-end devices**: 256-384 MB
- **Mid-range devices**: 384-512 MB
- **High-end devices**: 512 MB - 1 GB

## Current Implementation Details

### Files Modified:
1. **`app.json`**: Added `"largeHeap": true` to Android config
2. **`DatabaseManager.ts`**: Simplified JSON loading with direct decompression

### Dependencies Used:
- **`pako`**: For gzip decompression (more reliable than native DecompressionStream)
- **`expo-asset`**: For loading bundled assets

### Memory Optimization:
- Batch inserts (1000 records at a time) to avoid holding all data in memory
- Small delays between batches to allow garbage collection
- Direct decompression without intermediate processing steps

## Monitoring Memory Usage

To monitor memory usage during development:

### Android Studio Profiler:
1. Open Android Studio
2. Go to View > Tool Windows > Profiler
3. Select your app process
4. Monitor memory usage in real-time

### React Native DevTools:
- Use the Performance monitor in React Native DevTools
- Watch for memory spikes during JSON loading

## Troubleshooting

### If you still get OOM errors:
1. Check the device's available memory
2. Try on a different device (physical device recommended)
3. Consider splitting the JSON into smaller chunks
4. Consider the download-on-first-launch approach

### If the app crashes immediately:
1. Check logcat for detailed error messages: `adb logcat`
2. Verify the `.gz` file is properly bundled
3. Check that `pako` is installed: `pnpm list pako`

### If data doesn't load:
1. Check the console logs for error messages
2. Verify the database schema matches the JSON structure
3. Check that the asset path is correct in `require()`

## Next Steps

After successfully loading the initial resources:
1. Test the app functionality with the loaded data
2. Verify data integrity by checking a few records
3. Test on multiple devices if possible
4. Consider implementing a progress indicator for the initial load
5. Add error recovery mechanisms (e.g., retry logic)

## References

- [React Native Memory Management](https://reactnative.dev/docs/performance)
- [Android Large Heap Documentation](https://developer.android.com/topic/performance/memory)
- [Pako Library](https://github.com/nodeca/pako)








